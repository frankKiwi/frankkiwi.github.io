<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>屏幕镜像 - Cast Receiver</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: #000;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }
        #video {
            width: 100vw;
            height: 100vh;
            object-fit: contain;
            background: #000;
        }
        #status {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 16px;
            z-index: 1000;
            backdrop-filter: blur(10px);
            transition: opacity 0.3s;
        }
        #status.connected { background: rgba(0, 150, 0, 0.8); }
        #status.error { background: rgba(200, 0, 0, 0.8); }
        .spinner {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-right: 10px;
            vertical-align: middle;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <video id="video" autoplay playsinline muted></video>
    <div id="status"><span class="spinner"></span>正在连接...</div>

    <script>
        const video = document.getElementById('video');
        const status = document.getElementById('status');

        // 从 URL 参数获取手机 IP 和端口
        const params = new URLSearchParams(window.location.search);
        const phoneIP = params.get('ip') || location.hostname;
        const wsPort = params.get('wsport') || '1118';

        let pc;
        let ws;
        let reconnectAttempts = 0;

        function updateStatus(message, type = 'normal') {
            status.innerHTML = message;
            status.className = type;
            console.log('[状态] ' + message);
        }

        function connect() {
            updateStatus('<span class="spinner"></span>正在连接 ' + phoneIP + '...', 'normal');

            // 连接 WebSocket
            const wsURL = 'ws://' + phoneIP + ':' + wsPort;
            console.log('连接 WebSocket: ' + wsURL);
            ws = new WebSocket(wsURL);

            ws.onopen = () => {
                reconnectAttempts = 0;
                updateStatus('已连接，等待视频流...', 'normal');
                ws.send(JSON.stringify({ type: 'ready' }));
            };

            ws.onmessage = async (event) => {
                try {
                    const message = JSON.parse(event.data);
                    console.log('收到消息:', message.type);

                    if (message.type === 'offer') {
                        await handleOffer(message.sdp);
                    } else if (message.type === 'ice-candidate') {
                        await handleIceCandidate(message.candidate);
                    }
                } catch (error) {
                    console.error('处理消息错误:', error);
                }
            };

            ws.onerror = (error) => {
                updateStatus('连接错误', 'error');
                console.error('WebSocket 错误:', error);
            };

            ws.onclose = () => {
                updateStatus('连接断开', 'error');
                if (reconnectAttempts < 5) {
                    reconnectAttempts++;
                    setTimeout(connect, 2000);
                }
            };
        }

        async function handleOffer(sdp) {
            try {
                pc = new RTCPeerConnection({
                    iceServers: [
                        { urls: 'stun:stun.l.google.com:19302' },
                        { urls: 'stun:stun1.l.google.com:19302' }
                    ]
                });

                pc.ontrack = (event) => {
                    console.log('收到视频流');
                    video.srcObject = event.streams[0];
                    video.play().catch(e => console.log('自动播放失败'));
                    updateStatus('投屏中', 'connected');
                    setTimeout(() => { status.style.opacity = '0'; }, 3000);
                };

                pc.onicecandidate = (event) => {
                    if (event.candidate) {
                        ws.send(JSON.stringify({
                            type: 'ice-candidate',
                            candidate: {
                                candidate: event.candidate.candidate,
                                sdpMLineIndex: event.candidate.sdpMLineIndex,
                                sdpMid: event.candidate.sdpMid
                            }
                        }));
                    }
                };

                pc.onconnectionstatechange = () => {
                    console.log('连接状态:', pc.connectionState);
                    if (pc.connectionState === 'connected') {
                        updateStatus('投屏中', 'connected');
                    } else if (pc.connectionState === 'disconnected' || pc.connectionState === 'failed') {
                        updateStatus('连接断开', 'error');
                        status.style.opacity = '1';
                    }
                };

                await pc.setRemoteDescription({ type: 'offer', sdp: sdp });
                const answer = await pc.createAnswer();
                await pc.setLocalDescription(answer);

                ws.send(JSON.stringify({ type: 'answer', sdp: answer.sdp }));
                console.log('Answer 已发送');
            } catch (error) {
                console.error('处理 Offer 错误:', error);
                updateStatus('连接失败: ' + error.message, 'error');
            }
        }

        async function handleIceCandidate(candidate) {
            try {
                if (pc && candidate) {
                    await pc.addIceCandidate(new RTCIceCandidate(candidate));
                }
            } catch (error) {
                console.error('添加 ICE Candidate 错误:', error);
            }
        }

        // 启动
        console.log('Cast Receiver 启动, IP:', phoneIP);
        connect();
    </script>
</body>
</html>
